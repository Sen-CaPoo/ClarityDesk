# Feature Specification: LINE 官方帳號整合功能

**Feature Branch**: `002-line-integration`  
**Created**: 2025-10-23  
**Status**: Draft  
**Input**: User description: "LINE 官方帳號整合功能,包含帳號綁定、推送通知與 LINE 端回報問題"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - LINE 官方帳號綁定 (Priority: P1)

系統管理員或一般使用者需要將其 ClarityDesk 帳號與 LINE 官方帳號進行綁定,以便後續接收通知及使用 LINE 端功能。

**Why this priority**: 這是所有 LINE 整合功能的基礎。沒有完成綁定,使用者無法使用任何 LINE 相關功能。此功能可獨立測試和部署,為後續功能奠定基礎。

**Independent Test**: 可透過登入系統、點擊「綁定 LINE 官方帳號」按鈕、完成 LINE 好友新增流程、驗證系統顯示「已綁定」狀態來獨立測試。此功能不依賴其他 LINE 功能即可提供價值(建立帳號關聯)。

**Acceptance Scenarios**:

1. **Given** 使用者已登入 ClarityDesk 系統且尚未綁定 LINE,**When** 使用者點擊「綁定 LINE 官方帳號」按鈕,**Then** 系統顯示 LINE 官方帳號 QR Code 或導向 LINE 加入好友頁面
2. **Given** 使用者掃描 QR Code 並加入 LINE 官方帳號為好友,**When** 使用者在 LINE 中完成綁定驗證流程,**Then** 系統建立 ClarityDesk 使用者與 LINE User ID 的對應關係
3. **Given** 使用者已完成綁定,**When** 使用者返回 ClarityDesk 系統頁面,**Then** 系統顯示「已綁定」狀態並顯示綁定的 LINE 顯示名稱
4. **Given** 使用者已綁定 LINE 帳號,**When** 使用者點擊「解除綁定」按鈕並確認,**Then** 系統移除 ClarityDesk 與 LINE 的對應關係並顯示「未綁定」狀態
5. **Given** 使用者以訪客模式登入,**When** 使用者嘗試存取 LINE 綁定功能,**Then** 系統顯示「訪客帳號無法使用此功能」訊息並禁用綁定按鈕

---

### User Story 2 - 新增回報單時的 LINE 推送通知 (Priority: P2)

當系統新增一筆問題回報單時,指派的處理人員若已綁定 LINE 帳號,應立即在 LINE 收到推送通知,包含回報單摘要資訊與快速連結。

**Why this priority**: 此功能大幅提升處理人員的即時回應能力,但需要 P1(帳號綁定)完成後才能運作。獨立部署後可立即為已綁定的使用者提供通知價值。

**Independent Test**: 可透過在網頁端建立新回報單、指派給已綁定 LINE 的處理人員、驗證該人員的 LINE 收到包含完整資訊的推送訊息、點擊訊息中的連結能正確開啟回報單詳細頁面來獨立測試。

**Acceptance Scenarios**:

1. **Given** 處理人員已綁定 LINE 且被指派為某單位的預設處理人員,**When** 系統新增一筆該單位的回報單並自動指派給該處理人員,**Then** 該處理人員的 LINE 立即收到推送訊息
2. **Given** LINE 推送訊息已送達,**When** 處理人員查看訊息內容,**Then** 訊息包含:回報單編號、問題標題、緊急程度、問題所屬單位、聯絡人、連絡電話、紀錄日期、回報人等完整資訊
3. **Given** LINE 推送訊息中包含「查看回報單詳情」按鈕,**When** 處理人員點擊該按鈕,**Then** 系統開啟對應回報單的詳細頁面(透過 LINE 內建瀏覽器或外部瀏覽器)
4. **Given** 處理人員尚未綁定 LINE 帳號,**When** 系統新增回報單並指派給該處理人員,**Then** 系統不發送 LINE 推送通知(正常建立回報單,僅跳過 LINE 通知)
5. **Given** LINE API 發生錯誤或無法送達,**When** 系統嘗試推送訊息失敗,**Then** 系統記錄錯誤日誌但不影響回報單建立流程

---

### User Story 3 - LINE 端回報問題 (Priority: P3)

已綁定的使用者可直接在 LINE 對話中透過互動式流程回報問題,系統引導使用者逐步填寫必要資訊並自動建立回報單。

**Why this priority**: 此功能提供最大的使用便利性,但需要 P1 完成且實作較複雜。即使不實作此功能,使用者仍可透過網頁端回報問題,不影響核心業務流程。

**Independent Test**: 可透過在 LINE 中輸入「回報問題」關鍵字、依序填寫所有必要資訊、確認送出、驗證系統成功建立回報單且內容正確、確認網頁端可查看該回報單來獨立測試。

**Acceptance Scenarios**:

1. **Given** 使用者已綁定 LINE 帳號,**When** 使用者在 LINE 對話中輸入「回報問題」或點擊快速選單按鈕,**Then** 系統啟動回報流程並提示「請輸入問題標題」
2. **Given** 回報流程已啟動,**When** 使用者依序輸入問題標題、問題內容,**Then** 系統逐步引導並暫存已填寫的資訊
3. **Given** 系統詢問「問題所屬單位」,**When** 系統顯示目前存在的所有單位選項(以快速回覆按鈕呈現),**Then** 使用者可點擊選擇單位
4. **Given** 系統詢問「緊急程度」,**When** 系統顯示「🔴 高」、「🟡 中」、「🟢 低」三個選項,**Then** 使用者可點擊選擇緊急程度
5. **Given** 使用者完成所有必填欄位(問題標題、問題內容、所屬單位、緊急程度、聯絡人、連絡電話),**When** 系統顯示摘要並詢問確認,**Then** 摘要內容正確顯示所有已填寫資訊及系統自動填入的資訊(紀錄日期、回報人、指派處理人員)
6. **Given** 使用者確認送出,**When** 系統處理回報單建立,**Then** 系統成功建立回報單、回覆回報單編號與查看連結、該回報單立即同步至網頁端系統
7. **Given** 回報流程進行中,**When** 使用者輸入「取消」,**Then** 系統中斷流程、清除暫存資料並回覆「已取消回報流程」
8. **Given** 使用者在 LINE 端建立回報單,**When** 該回報單的指派處理人員已綁定 LINE,**Then** 處理人員同樣收到 LINE 推送通知(與網頁端新增的回報單行為一致)
9. **Given** 使用者輸入的資料格式不正確(例如電話號碼格式錯誤),**When** 系統驗證輸入內容,**Then** 系統提示錯誤訊息並要求重新輸入

---

### Edge Cases

- **網路中斷**: 使用者在 LINE 端回報流程中網路中斷,系統如何處理暫存資料?
  - 系統應設定 Session 逾時機制(建議 30 分鐘),逾時後清除暫存資料。
  - 使用者恢復連線後需重新開始回報流程。

- **重複綁定**: 使用者嘗試將同一個 LINE 帳號綁定到多個 ClarityDesk 帳號,系統如何處理?
  - 系統應允許一個 LINE 帳號只能綁定一個 ClarityDesk 帳號。
  - 若嘗試重複綁定,系統提示「此 LINE 帳號已綁定其他帳號」並拒絕操作。

- **處理人員變更**: 回報單建立後若手動變更指派的處理人員,新的處理人員是否收到通知?
  - 根據現有需求,僅在「新增回報單時」發送通知。
  - 若需要變更時也通知,需明確在需求中說明(目前不在範圍內)。

- **LINE API 限制**: LINE Messaging API 有訊息推送限制(例如每月免費額度),超過限制時如何處理?
  - 系統應監控 API 使用量並在接近限制時發送警告給系統管理員。
  - 超過限制時,系統記錄無法發送的訊息並通知管理員,但不影響回報單建立。

- **多語系支援**: LINE 端的互動訊息是否需要支援多語系?
  - 目前需求僅提及繁體中文,預設不需要多語系支援。
  - 若未來需要,應在系統配置中加入語系設定。

- **LINE 帳號被封鎖**: 使用者在 LINE 中封鎖官方帳號後,系統如何處理?
  - 系統嘗試推送訊息會失敗,應記錄錯誤並標記該使用者的 LINE 綁定狀態為「已封鎖」。
  - 使用者解除封鎖後,系統需提供機制重新啟用通知(例如在 LINE 中輸入特定指令)。

- **快速連結的安全性**: LINE 推送訊息中的快速連結如何確保安全性,避免未授權存取?
  - 連結應包含時效性 Token(建議有效期 24 小時)或需要使用者再次登入驗證。

## Requirements *(mandatory)*

### Functional Requirements

#### LINE 官方帳號綁定

- **FR-001**: 系統必須在使用者設定頁面或個人資料頁面提供「綁定 LINE 官方帳號」按鈕
- **FR-002**: 系統必須在使用者點擊綁定按鈕後,顯示 LINE 官方帳號的 QR Code 或導向 LINE 加入好友的 URL
- **FR-003**: 系統必須提供 LINE Bot Webhook 端點,接收來自 LINE Platform 的事件(follow、message、postback 等)
- **FR-004**: 系統必須在使用者加入 LINE 官方帳號後,透過驗證流程(例如一次性驗證碼)建立 ClarityDesk 使用者 ID 與 LINE User ID 的對應關係
- **FR-005**: 系統必須將綁定資訊儲存至資料庫,包含:ClarityDesk 使用者 ID、LINE User ID、LINE 顯示名稱、綁定時間
- **FR-006**: 系統必須在綁定成功後,於網頁端顯示「已綁定」狀態及綁定的 LINE 顯示名稱
- **FR-007**: 系統必須提供「解除綁定」功能,並在使用者確認後移除綁定資料
- **FR-008**: 系統必須限制訪客帳號無法使用 LINE 綁定功能,並在介面上禁用或隱藏相關按鈕
- **FR-009**: 系統必須確保一個 LINE User ID 只能綁定一個 ClarityDesk 帳號,重複綁定時拒絕操作並提示錯誤訊息

#### 新增回報單時的 LINE 推送通知

- **FR-010**: 系統必須在新增回報單時,檢查指派的處理人員是否已綁定 LINE 帳號
- **FR-011**: 系統必須透過 LINE Messaging API 推送訊息給已綁定的處理人員
- **FR-012**: 推送訊息必須包含以下資訊:回報單編號、問題標題、緊急程度(以表情符號標示:🔴 高、🟡 中、🟢 低)、問題所屬單位、聯絡人、連絡電話、紀錄日期、回報人
- **FR-013**: 推送訊息必須包含「查看回報單詳情」按鈕或連結,點擊後開啟對應回報單的詳細頁面
- **FR-014**: 系統必須確保回報單詳細頁面的 URL 包含必要的驗證機制(例如時效性 Token 或需登入驗證)
- **FR-015**: 系統必須在 LINE API 推送失敗時記錄錯誤日誌,但不影響回報單建立流程
- **FR-016**: 系統必須在處理人員未綁定 LINE 時,正常建立回報單但跳過 LINE 通知

#### LINE 端回報問題

- **FR-017**: 系統必須監聽 LINE 使用者傳送的訊息,識別關鍵字「回報問題」或快速選單按鈕點擊事件
- **FR-018**: 系統必須在偵測到回報問題指令後,啟動互動式對話流程,並依序詢問:問題標題、問題內容、問題所屬單位、緊急程度、聯絡人、連絡電話
- **FR-019**: 系統必須在詢問「問題所屬單位」時,從資料庫查詢所有啟用中的單位並以快速回覆按鈕(Quick Reply)呈現
- **FR-020**: 系統必須在詢問「緊急程度」時,提供「🔴 高」、「🟡 中」、「🟢 低」三個快速回覆按鈕
- **FR-021**: 系統必須暫存使用者在對話流程中輸入的所有資訊(使用 Session 或快取機制)
- **FR-022**: 系統必須驗證使用者輸入的資料格式(例如電話號碼格式),格式錯誤時提示錯誤訊息並要求重新輸入
- **FR-023**: 系統必須在使用者完成所有必填欄位後,顯示摘要供使用者確認,摘要內容包含:使用者填寫的所有資訊、系統自動填入的資訊(紀錄日期、回報人、處理狀態、指派處理人員)
- **FR-024**: 系統必須在摘要顯示後,提供「確認送出」、「重新填寫」、「取消」三個操作選項(以快速回覆按鈕呈現)
- **FR-025**: 系統必須在使用者點擊「確認送出」後,建立回報單至資料庫,並將「紀錄日期」設為當下時間、「回報人」從綁定帳號帶入、「處理狀態」設為「待處理」、「指派處理人員」根據所屬單位的預設處理人員自動指派
- **FR-026**: 系統必須在回報單建立成功後,回覆使用者回報單編號及查看連結
- **FR-027**: 系統必須確保 LINE 端建立的回報單與網頁端建立的回報單功能完全相同,立即同步至系統中
- **FR-028**: 系統必須在使用者於回報流程中輸入「取消」時,中斷流程、清除暫存資料並回覆確認訊息
- **FR-029**: 系統必須設定回報流程的 Session 逾時機制(建議 30 分鐘),逾時後自動清除暫存資料
- **FR-030**: 系統必須在 LINE 端建立回報單且指派的處理人員已綁定 LINE 時,發送推送通知給該處理人員(遵循 FR-010 至 FR-016 的通知邏輯)

### Key Entities

- **LineBinding(LINE 綁定關聯)**:
  - 代表 ClarityDesk 使用者與 LINE 帳號的綁定關係
  - 關鍵屬性:ClarityDesk 使用者 ID、LINE User ID、LINE 顯示名稱、綁定時間、狀態(正常/已封鎖)
  - 關聯:一個 ClarityDesk 使用者可綁定一個 LINE 帳號;一個 LINE 帳號只能綁定一個 ClarityDesk 使用者

- **LineConversationSession(LINE 對話 Session)**:
  - 代表使用者在 LINE 端進行回報問題時的對話狀態
  - 關鍵屬性:Session ID、LINE User ID、當前步驟、暫存資料(問題標題、內容、單位等)、建立時間、最後更新時間
  - 關聯:一個 LINE 使用者同時只能有一個進行中的 Session

- **IssueReport(問題回報單)**:
  - 現有實體,需確保 LINE 端建立的回報單與網頁端建立的回報單結構完全相同
  - 新增屬性:來源(網頁端/LINE 端),用於追蹤回報單的建立來源

- **User(使用者)**:
  - 現有實體,與 LineBinding 建立一對一關係
  - 訪客帳號需有標記以識別並禁止 LINE 綁定

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 3 分鐘內完成 LINE 官方帳號綁定流程(從點擊「綁定 LINE」到系統顯示「已綁定」狀態)
- **SC-002**: 已綁定的處理人員在回報單建立後 10 秒內收到 LINE 推送通知
- **SC-003**: LINE 推送通知的訊息送達率達 95% 以上(排除使用者封鎖、網路問題等外部因素)
- **SC-004**: 使用者可在 5 分鐘內透過 LINE 完成問題回報流程(從輸入「回報問題」到收到回報單編號)
- **SC-005**: LINE 端建立的回報單與網頁端建立的回報單在資料庫中的結構完全相同,網頁端可正常查看、編輯、處理
- **SC-006**: 系統可支援至少 100 個並行的 LINE 對話 Session 而不影響回應速度(回應時間不超過 3 秒)
- **SC-007**: 90% 的使用者能在首次使用時成功完成 LINE 端回報流程,無需外部協助或說明文件
- **SC-008**: 系統管理員可透過日誌或管理介面查看 LINE API 使用量,並在接近月額度限制時收到警告
- **SC-009**: LINE Webhook 端點的可用性達 99.5% 以上,確保訊息接收不中斷
- **SC-010**: 使用者對 LINE 整合功能的滿意度評分達 4.0 分以上(滿分 5 分)

## Assumptions

- LINE 官方帳號已由系統管理員在 LINE Developers Console 建立並取得必要的 API 憑證(Channel ID、Channel Secret、Channel Access Token)
- 系統已具備 HTTPS 端點,可接收來自 LINE Platform 的 Webhook 事件
- 系統的現有使用者模型(User entity)可擴充以支援 LINE 綁定關聯
- 訪客帳號在現有系統中已有明確標記或識別機制
- LINE 推送訊息的快速連結將開啟網頁版的回報單詳細頁面,不需要額外開發 LINE LIFF(LINE Front-end Framework)應用程式
- 電話號碼格式驗證採用台灣地區常見格式(09XX-XXXXXX 或 09XXXXXXXX)
- 系統使用的 LINE Messaging API 方案提供足夠的免費推送訊息額度,或已編列預算支付額外費用
- LINE 端對話流程的逾時時間設定為 30 分鐘,此時間足以讓大部分使用者完成回報
- 系統現有的單位(Department)與使用者(User)資料模型已包含「預設處理人員」的關聯設定

## Dependencies

- **LINE Developers Console 設定**: 需先完成 LINE 官方帳號建立、Messaging API 啟用、Webhook URL 設定
- **SSL 憑證**: 系統需具備有效的 SSL 憑證,LINE Webhook 僅支援 HTTPS
- **現有的回報單建立邏輯**: LINE 推送通知功能依賴現有的回報單建立流程,需確保該流程穩定且包含指派處理人員的邏輯
- **單位與預設處理人員關聯**: LINE 端回報問題功能依賴系統中已設定的「單位與預設處理人員」關聯資料
- **使用者認證機制**: LINE 綁定驗證流程需與現有的使用者認證機制整合(例如產生一次性驗證碼)

## Out of Scope

以下項目不在本次功能範圍內,若需要應另行規劃:

- **LINE LIFF 應用程式**: 不開發 LINE 內嵌的前端應用程式,快速連結僅開啟網頁版頁面
- **多語系支援**: LINE 端訊息僅提供繁體中文,不支援其他語系
- **LINE 群組或多人聊天室整合**: 僅支援一對一的 LINE 官方帳號對話,不支援群組通知或管理
- **回報單狀態變更通知**: 僅在「新增回報單」時推送通知,回報單狀態變更(例如處理中→已完成)不發送 LINE 通知
- **LINE 端查看回報單列表**: 使用者無法在 LINE 中查看所有回報單,需開啟網頁版查看
- **LINE 端編輯或更新回報單**: 使用者無法在 LINE 中編輯已建立的回報單,僅能透過網頁端操作
- **圖片或檔案上傳**: LINE 端回報問題時不支援上傳圖片或附件
- **LINE Pay 或付款功能整合**: 本功能不涉及任何付款相關功能
- **LINE Beacon 或位置資訊整合**: 不使用 LINE Beacon 或地理位置資訊
- **自動化 Chatbot 回覆**: 除了回報問題流程外,不提供其他自動化問答或 FAQ 功能

## Risks & Mitigations

- **風險:LINE API 使用量超過免費額度**
  - 緩解措施:實作 API 使用量監控機制,並在接近限制時暫停非關鍵通知或通知管理員

- **風險:LINE Webhook 端點遭受惡意攻擊或垃圾訊息**
  - 緩解措施:驗證所有來自 LINE Platform 的請求簽章(使用 Channel Secret),拒絕未經驗證的請求

- **風險:使用者在 LINE 端回報流程中提供不正確或惡意資料**
  - 緩解措施:實作資料格式驗證與清理(sanitization),防止 SQL Injection 或 XSS 攻擊

- **風險:LINE 平台服務中斷或 API 變更**
  - 緩解措施:實作錯誤處理機制,確保 LINE 服務中斷時不影響核心回報單建立功能;定期關注 LINE API 更新公告

- **風險:使用者綁定後更換 LINE 帳號或解除好友**
  - 緩解措施:提供「重新綁定」功能,並在推送失敗時標記綁定狀態;定期清理無效綁定資料

## Notes

- LINE Messaging API 提供的訊息類型包含 Text、Template(Buttons、Confirm、Carousel)、Flex Message 等,本規格建議使用 Flex Message 實現推送通知的視覺化排版
- LINE 快速回覆(Quick Reply)最多支援 13 個按鈕,單位選擇若超過此數量需考慮分頁或其他呈現方式
- LINE Bot 需要在 LINE Developers Console 設定「自動回覆訊息」為關閉,否則會與自訂回覆衝突
- 建議在系統管理介面提供「LINE 綁定管理」頁面,讓管理員可查看所有綁定狀態並手動解除綁定(例如處理異常情況)
- 考慮實作「測試推送」功能,讓管理員可手動觸發 LINE 訊息推送以驗證功能正常運作

