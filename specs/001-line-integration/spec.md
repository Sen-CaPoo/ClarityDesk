# Feature Specification: LINE 整合功能

**Feature Branch**: `001-line-integration`
**Created**: 2025-10-31
**Status**: Draft
**Input**: User description: "顧客問題紀錄追蹤網站追加需求 - LINE 整合功能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - LINE 官方帳號綁定管理 (Priority: P1)

系統管理員或一般使用者需要將個人帳號與 LINE 官方帳號綁定,以便接收問題通知並透過 LINE 進行問題回報。使用者可在系統介面中查看綁定狀態,執行綁定或解除綁定操作。

**Why this priority**: 這是所有 LINE 功能的基礎。沒有帳號綁定,後續的通知推送和 LINE 端回報都無法運作。這是最核心的前置功能。

**Independent Test**: 可獨立測試綁定流程 - 使用者點擊「綁定 LINE 官方帳號」按鈕後,系統引導完成綁定並正確顯示綁定狀態;解除綁定後狀態正確更新。此功能可獨立部署並立即為使用者帶來價值(建立 LINE 連結)。

**Acceptance Scenarios**:

1. **Given** 使用者已登入系統且尚未綁定 LINE, **When** 使用者點擊「綁定 LINE 官方帳號」按鈕, **Then** 系統引導使用者加入 LINE 官方帳號並完成綁定流程
2. **Given** 使用者完成綁定流程, **When** 系統建立帳號對應關係, **Then** 系統介面顯示「已綁定」狀態並提供解除綁定按鈕
3. **Given** 使用者已綁定 LINE, **When** 使用者點擊「解除綁定」按鈕, **Then** 系統移除對應關係並更新介面為「未綁定」狀態
4. **Given** 使用者為訪客帳號, **When** 使用者嘗試綁定 LINE, **Then** 系統拒絕操作並顯示錯誤訊息「訪客帳號不可綁定 LINE」
5. **Given** 使用者登入系統, **When** 進入個人設定或帳號管理頁面, **Then** 系統顯示當前 LINE 綁定狀態(已綁定/未綁定)

---

### User Story 2 - 新增問題時自動推送 LINE 通知 (Priority: P2)

當系統中新增一筆問題回報單時,系統自動推送 LINE 訊息通知給已綁定 LINE 的指派處理人員。訊息包含回報單重要資訊(編號、標題、緊急程度、所屬單位、聯絡人、電話、日期、回報人)以及可直接開啟詳細頁面的快速連結。

**Why this priority**: 提升問題處理的即時性。處理人員可立即透過手機收到新問題通知,不需登入網站即可掌握問題概況,並快速採取行動。這是 LINE 整合的核心價值之一。

**Independent Test**: 可獨立測試通知推送 - 在系統中新增一筆問題回報單並指派給已綁定 LINE 的處理人員,處理人員的 LINE 應收到包含完整資訊和快速連結的推送訊息。此功能可在帳號綁定完成後獨立部署。

**Acceptance Scenarios**:

1. **Given** 系統新增一筆問題回報單並指派給已綁定 LINE 的處理人員, **When** 回報單儲存成功, **Then** 系統自動推送 LINE 訊息給該處理人員
2. **Given** 推送訊息內容, **When** 處理人員收到 LINE 訊息, **Then** 訊息包含:回報單編號、問題標題、緊急程度、問題所屬單位、聯絡人、連絡電話、紀錄日期、回報人
3. **Given** LINE 推送訊息, **When** 處理人員點擊訊息中的快速連結按鈕, **Then** 系統開啟該回報單的詳細頁面
4. **Given** 問題回報單指派給未綁定 LINE 的處理人員, **When** 回報單儲存成功, **Then** 系統不推送 LINE 訊息(維持現有通知機制)
5. **Given** 推送訊息格式, **When** 處理人員檢視訊息, **Then** 訊息格式符合範例樣式(包含適當的表情符號和分隔線)

---

### User Story 3 - LINE 端直接回報問題 (Priority: P3)

已綁定 LINE 的使用者可直接在 LINE 官方帳號中透過對話方式回報問題。系統引導使用者依序填寫問題標題、內容、所屬單位、緊急程度、聯絡人、電話等資訊,並自動填入紀錄日期、回報人、處理狀態和指派人員。使用者確認後建立回報單,系統回覆回報單編號與查看連結。

**Why this priority**: 提供最便利的問題回報管道。使用者可隨時隨地透過 LINE 快速回報,無需登入網站,大幅降低回報門檻。雖然重要,但前兩項功能是此功能的基礎,因此優先級較低。

**Independent Test**: 可獨立測試 LINE 端回報流程 - 已綁定使用者在 LINE 輸入「回報問題」,系統引導完成所有步驟,建立的回報單立即出現在網頁系統中且內容完整正確。此功能可在前兩項功能完成後獨立部署。

**Acceptance Scenarios**:

1. **Given** 使用者已完成 LINE 綁定, **When** 使用者在 LINE 輸入「回報問題」或點擊快速選單, **Then** 系統啟動回報流程並詢問問題標題
2. **Given** 回報流程進行中, **When** 系統依序引導填寫問題標題、內容、所屬單位、緊急程度、聯絡人、電話, **Then** 每個步驟都提供清楚的指引和選項(如單位選擇、緊急程度選擇)
3. **Given** 使用者完成所有資訊填寫, **When** 系統顯示摘要供確認, **Then** 摘要包含所有填寫和自動填入的資訊(問題標題、內容、所屬單位、緊急程度、聯絡人、電話、回報人)
4. **Given** 使用者確認摘要內容, **When** 使用者點擊「確認送出」, **Then** 系統建立回報單並回覆回報單編號、指派人員和查看連結
5. **Given** LINE 端建立的回報單, **When** 在網頁系統中查詢該回報單, **Then** 回報單立即出現且所有資訊完整同步(包含自動填入的紀錄日期、回報人、處理狀態、指派人員)
6. **Given** 使用者正在填寫回報流程, **When** 使用者輸入「取消」, **Then** 系統中斷回報流程並確認取消
7. **Given** 系統需要自動指派處理人員, **When** 使用者選擇問題所屬單位, **Then** 系統根據該單位的預設處理人員自動指派
8. **Given** 對話流程範例, **When** 使用者與系統互動, **Then** 對話流程符合需求描述中的示例(使用適當的表情符號和快速選單按鈕)

---

### Edge Cases

- 當處理人員已綁定 LINE 但後來解除綁定,系統如何處理新問題的通知?(系統不推送 LINE 訊息,維持其他通知機制)
- 當使用者在 LINE 回報流程中途離開或長時間未回應,系統如何處理?(設定逾時機制,例如 30 分鐘未回應則自動取消流程)
- 當 LINE 官方帳號服務暫時無法使用,系統如何確保問題回報功能不受影響?(LINE 推送失敗不影響回報單建立,系統記錄錯誤並可選擇性重試)
- 當使用者嘗試綁定已被其他帳號綁定的 LINE 帳號,系統如何處理?(系統檢測並拒絕重複綁定,顯示錯誤訊息「此 LINE 帳號已綁定其他使用者」)
- 當所屬單位沒有預設處理人員,系統如何自動指派?(系統使用全域預設邏輯,例如指派給單位主管或系統管理員,或標記為「待指派」)
- 當使用者在 LINE 填寫資料格式錯誤(例如電話格式),系統如何驗證和引導?(系統驗證輸入格式,格式錯誤時提示使用者重新輸入並提供正確格式範例)
- 當問題回報單被刪除或修改後,先前推送的 LINE 連結是否仍有效?(連結應保持有效,但開啟時顯示問題已刪除或最新狀態)

## Requirements *(mandatory)*

### Functional Requirements

#### LINE 官方帳號綁定功能

- **FR-001**: 系統必須提供「綁定 LINE 官方帳號」按鈕供已登入使用者點擊
- **FR-002**: 系統必須在使用者點擊綁定按鈕後引導使用者加入 LINE 官方帳號並完成綁定流程
- **FR-003**: 系統必須在綁定完成後建立並儲存使用者帳號與 LINE 帳號的對應關係
- **FR-004**: 系統必須在介面中顯示當前使用者的 LINE 綁定狀態(已綁定/未綁定)
- **FR-005**: 系統必須提供「解除綁定」功能供已綁定使用者使用
- **FR-006**: 系統必須拒絕訪客帳號的綁定請求並顯示適當錯誤訊息
- **FR-007**: 系統必須防止同一個 LINE 帳號被多個系統帳號綁定

#### LINE 推送通知功能

- **FR-008**: 系統必須在新增問題回報單時檢查指派處理人員的 LINE 綁定狀態
- **FR-009**: 系統必須向已綁定 LINE 的指派處理人員推送包含以下資訊的訊息:回報單編號、問題標題、緊急程度、問題所屬單位、聯絡人、連絡電話、紀錄日期、回報人
- **FR-010**: 系統必須在推送訊息中提供快速連結按鈕,點擊後可直接開啟該回報單的詳細頁面
- **FR-011**: 推送訊息格式必須符合需求描述中提供的範例樣式(包含適當的表情符號、分隔線和區塊結構)
- **FR-012**: 系統必須處理 LINE 推送失敗的情況,確保推送失敗不影響回報單的正常建立
- **FR-013**: 系統必須記錄 LINE 推送的成功或失敗狀態供問題追蹤

#### LINE 端問題回報功能

- **FR-014**: 系統必須允許已綁定 LINE 的使用者透過輸入「回報問題」關鍵字或點擊快速選單啟動回報流程
- **FR-015**: 系統必須透過對話方式依序引導使用者填寫:問題標題、問題內容、問題所屬單位、緊急程度、聯絡人、連絡電話
- **FR-016**: 系統必須在詢問問題所屬單位時,提供當前存在的所有單位選項供使用者選擇
- **FR-017**: 系統必須在詢問緊急程度時,提供「低」、「中」、「高」三個選項供使用者選擇
- **FR-018**: 系統必須自動填入以下資訊:紀錄日期(當下時間)、回報人(從綁定帳號帶入)、處理狀態(預設為待處理)、指派處理人員(根據所屬單位的預設處理人員自動指派)
- **FR-019**: 系統必須在使用者完成所有填寫後顯示摘要供確認,摘要包含所有填寫和自動填入的資訊
- **FR-020**: 系統必須在使用者確認後建立回報單,並回覆回報單編號、指派人員姓名和查看連結
- **FR-021**: LINE 端建立的回報單必須立即同步至網頁系統,功能與網頁端建立的回報單完全相同
- **FR-022**: 系統必須允許使用者在填寫過程中隨時輸入「取消」以中斷回報流程
- **FR-023**: 系統必須驗證使用者輸入的資料格式(例如電話號碼),格式錯誤時提示重新輸入並提供格式範例
- **FR-024**: 系統必須處理回報流程逾時情況(例如使用者長時間未回應),自動取消未完成的回報流程

### Key Entities

- **LINE 綁定記錄**: 儲存系統使用者帳號與 LINE 使用者識別碼的對應關係,包含綁定時間、綁定狀態、LINE 使用者資訊
- **LINE 推送記錄**: 記錄每次 LINE 推送的詳細資訊,包含推送目標、推送內容摘要、推送時間、推送狀態(成功/失敗)、關聯的問題回報單
- **LINE 對話狀態**: 儲存使用者在 LINE 端回報問題時的對話進度和暫存資料,包含當前步驟、已填寫資訊、建立時間、逾時時間

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 1 分鐘內完成 LINE 官方帳號綁定流程
- **SC-002**: 新增問題回報單後,已綁定 LINE 的處理人員在 10 秒內收到推送通知
- **SC-003**: 使用者可在 3 分鐘內透過 LINE 完成問題回報流程(從啟動到建立成功)
- **SC-004**: LINE 端建立的回報單在 5 秒內同步至網頁系統並可正常查詢
- **SC-005**: 90% 的 LINE 推送訊息成功送達已綁定使用者
- **SC-006**: LINE 端回報流程的完成率達 80%(啟動流程的使用者中成功建立回報單的比例)
- **SC-007**: 使用者對 LINE 整合功能的滿意度達 85% 以上(透過問卷或回饋調查)
- **SC-008**: LINE 推送功能啟用後,問題平均處理時間縮短 30%(相較於僅使用網頁通知)
