<!--
同步影響報告:
- 版本變更: 1.0.0 → 1.1.0
- 修改原則: 新增文件語言要求,將所有面向使用者的內容轉換為繁體中文
- 新增章節: 新增「V. 文件與溝通」原則
- 修改章節: 所有內容翻譯為繁體中文
- 需要更新的範本:
  ✅ plan-template.md - 憲法檢查區段相容
  ✅ spec-template.md - 需求與驗收標準符合原則
  ✅ tasks-template.md - 任務結構支援測試優先與獨立測試
- 後續待辦事項: 無 - 所有欄位已填寫
-->

# ClarityDesk 專案憲法

## 核心原則

### I. 程式碼品質與可維護性 (不可協商)

所有程式碼必須符合以下品質標準:

- **整潔架構 (Clean Architecture)**: 在 Pages、Models、Services 與 Data 層之間必須有明確的關注點分離
- **SOLID 原則**: 必須應用單一職責、開放封閉、里氏替換、介面隔離、依賴反轉原則
- **命名慣例**: 一致遵循 Microsoft C# 命名慣例 (公開成員使用 PascalCase,私有欄位使用底線前綴的 camelCase)
- **程式碼文件**: 所有公開 API、複雜演算法與業務邏輯必須具備 XML 文件註解
- **可空參考型別 (Nullable Reference Types)**: 充分利用 C# 可空參考型別 (專案中已啟用);所有可空性標註必須明確且正確
- **依賴注入 (Dependency Injection)**: 所有服務必須透過 ASP.NET Core DI 容器註冊與解析;避免使用服務定位器模式
- **組態管理**: 所有組態必須使用 `appsettings.json` 搭配強型別選項類別;禁止硬編碼值
- **錯誤處理**: 使用結構化例外處理搭配自訂例外類型處理領域錯誤;絕不能無聲地吞噬例外

**理由**: 高程式碼品質確保長期可維護性、減少技術債務,並促進團隊擴展性。整潔架構模式使程式碼庫對任何團隊成員都易於理解與修改。

### II. 測試優先開發 (不可協商)

測試為強制性要求,必須嚴格遵守測試優先方法論:

- **TDD 循環**: 撰寫測試 → 使用者核准 → 測試失敗 → 實作 → 測試通過 → 重構
- **測試覆蓋率要求**:
  - **單元測試**: 服務與業務邏輯必須達到最低 80% 程式碼覆蓋率
  - **整合測試**: 所有 API 端點、資料庫操作與外部服務互動都需要整合測試
  - **UI 測試**: 關鍵使用者工作流程需要使用 Razor Pages PageModel 測試
- **測試獨立性**: 每個測試必須可獨立執行,不依賴執行順序
- **測試組織**: 遵循命名慣例 `[方法名稱]_[情境]_[預期結果]`
- **測試框架**: 使用 xUnit 作為主要測試框架;使用 FluentAssertions 提供可讀性高的斷言
- **模擬策略**: 使用 Moq 進行服務模擬;在可行的情況下優先採用具實際依賴的整合測試
- **測試資料管理**: 使用建構器/工廠模式建立測試資料;避免跨測試的共享可變狀態

**理由**: 測試優先開發能及早發現錯誤、記錄預期行為、支援自信重構,並確保功能在交付前按規格運作。紅-綠-重構循環從源頭強化品質。

### III. 使用者體驗一致性

面向使用者的功能必須提供一致、無障礙且直觀的體驗:

- **響應式設計**: 所有頁面必須完全響應式,並在桌面 (1920x1080)、平板 (768x1024) 與行動裝置 (375x667) 視窗上進行測試
- **無障礙性**: 必須符合 WCAG 2.1 Level AA 標準
  - 必須適當使用語意化 HTML5 元素
  - 所有互動元素必須可透過鍵盤導覽
  - 所有圖片必須具有描述性替代文字
  - 色彩對比度必須符合一般文字 4.5:1、大型文字 3:1
  - 表單驗證錯誤必須向螢幕閱讀器宣告
- **視覺一致性**: 使用共享版面配置 (`_Layout.cshtml`)、一致的元件模式與標準化 CSS 類別
- **表單驗證**: 在 PageModel 中使用 jQuery Validation 進行客戶端驗證與伺服器端驗證;顯示清晰、可操作的錯誤訊息
- **載入狀態**: 為所有非同步操作提供視覺回饋 (載入圖示、骨架螢幕、進度指示器)
- **錯誤處理**: 顯示使用者友善的錯誤訊息;在正式環境中絕不暴露堆疊追蹤或技術細節
- **瀏覽器支援**: 必須支援 Chrome、Firefox、Edge、Safari 的最新兩個版本

**理由**: 一致的 UX 建立使用者信任並減少支援負擔。無障礙性確保應用程式對所有使用者都可用,無論其能力如何。可預測的模式減少認知負荷與培訓需求。

### IV. 效能與可擴展性

應用程式必須符合定義的效能基準並有效擴展:

- **回應時間標準**:
  - 頁面載入 (伺服器端呈現): < 200ms (p95)
  - API 回應: < 100ms (p95)
  - 資料庫查詢: < 50ms (p95)
- **資源限制**:
  - 每個請求的記憶體使用量: < 50MB
  - CPU 使用率: 正常負載下 < 30%
  - 資料庫連線池: 最小 10 個、最大 100 個連線
- **最佳化要求**:
  - 資料庫查詢必須使用適當的索引;禁止 N+1 查詢模式
  - 靜態資產必須進行打包、最小化,並使用快取標頭提供服務 (有版本的資產快取 365 天)
  - 圖片必須最佳化並以現代格式提供 (WebP 搭配 JPEG 備援)
  - 對所有文字回應啟用回應壓縮 (Gzip/Brotli)
  - 一致使用 async/await;避免阻塞 I/O 操作
- **監控**:
  - 必須設定 Application Insights 或同等 APM
  - 為業務關鍵操作自訂度量
  - 使用相關 ID 進行請求追蹤的結構化日誌記錄
- **負載測試**: 處理使用者互動的功能在正式部署前必須進行 2 倍預期尖峰並發使用者的負載測試

**理由**: 效能直接影響使用者滿意度與營運成本。主動最佳化與監控防止應用程式擴展時效能下降。符合具體基準確保問責制與可預測的系統行為。

### V. 文件與溝通 (不可協商)

所有專案文件與使用者導向內容必須符合語言與格式標準:

- **文件語言**: 所有規格說明、計畫與使用者導向文件必須使用繁體中文 (zh-TW) 撰寫
- **程式碼註解**: XML 文件註解與重要程式碼註解使用繁體中文,以便團隊協作
- **使用者介面**: 所有使用者介面文字、錯誤訊息與提示必須使用繁體中文
- **API 文件**: API 端點與資料模型的說明文件使用繁體中文
- **技術文件**: 技術設計文件、架構決策記錄 (ADR) 與操作手冊使用繁體中文
- **範本一致性**: 使用 `.specify/templates/` 中的範本確保文件結構與格式一致
- **版本控制**: 所有文件必須與程式碼版本同步更新

**理由**: 使用統一的繁體中文文件確保團隊溝通清晰、減少誤解,並為華語使用者提供最佳體驗。標準化的文件格式提高可讀性與可維護性。

## 效能標準

### 測量與執行

- **效能關卡**: 所有功能在合併前必須通過效能驗證
- **效能分析**: 使用 BenchmarkDotNet 進行微基準測試;在代表性正式資料上執行效能分析
- **回歸預防**: CI/CD 管線中的自動化效能測試;如回應時間超過閾值 20%,建置失敗
- **定期稽核**: 每季對前 10 個最常用頁面與操作進行效能審查
- **資料庫效能**:
  - 必須審查所有新查詢的查詢執行計畫
  - 必須在正式規模資料上測試資料庫遷移腳本
  - 必須維護索引;每月分析查詢模式

### 可擴展性目標

- **水平擴展性**: 應用程式必須無狀態,以支援跨多個執行個體的水平擴展
- **快取策略**:
  - 對公開/半靜態內容進行回應快取 (預設 5 分鐘)
  - 對工作階段狀態與共享資料使用分散式快取 (Redis)
  - 對參考資料使用記憶體內快取 (透過 `IMemoryCache` 管理)
- **並發使用者**: 系統必須支援每個執行個體 1,000 個並發使用者而不降級
- **資料成長**: 架構必須在不進行重大重構的情況下支援目前資料量的 10 倍

## 開發工作流程

### 程式碼審查要求

- **強制審查**: 所有程式碼變更在合併前必須經過至少一位其他開發人員審查
- **審查清單**:
  - 憲法合規性 (所有四項核心原則)
  - 測試覆蓋率符合要求
  - 評估效能影響
  - 處理安全性考量
  - 滿足無障礙性要求 (針對 UI 變更)
  - 更新文件 (README、XML 註解、遷移指南)
- **審查回應**: 審查必須在 1 個工作日內處理
- **阻塞問題**: 安全性漏洞、效能回歸或無障礙性違規會阻塞合併

### 品質關卡

合併前驗證必須包含:

1. **建置**: 零警告的乾淨建置 (將警告視為錯誤)
2. **測試**: 所有測試通過;新程式碼由測試覆蓋
3. **程式碼檢查**: 程式碼分析 (Roslyn 分析器) 通過且零違規
4. **安全性**: 相依性掃描顯示無高/嚴重漏洞
5. **效能**: 自動化效能測試在可接受閾值內

### 分支策略

- **功能分支**: 使用格式 `###-feature-name` 對應規格/議題編號
- **分支保護**: 主分支受保護;需要 PR 搭配核准與通過 CI
- **提交訊息**: 遵循傳統提交格式: `type(scope): description`
  - 類型: `feat`、`fix`、`docs`、`style`、`refactor`、`test`、`chore`
  - 範例: `feat(auth): 新增密碼重設功能`

### 文件要求

- **功能文件**: 每項功能必須在 `.specify/specs/` 中有遵循 spec-template.md 的規格說明
- **API 文件**: 使用 XML 註解記錄公開 API,並匯出至生成的文件
- **操作手冊**: 更新需要部署組態或監控的功能的操作手冊
- **遷移指南**: 重大變更必須包含相依程式碼的遷移指南

## 治理

本憲法優先於所有其他開發實務與指南。所有團隊成員必須遵守這些原則。

**修訂流程**:

- 提議的修訂必須記錄理由
- 需要技術負責人核准與團隊共識 (75% 同意)
- 影響現有程式碼的變更需要遷移計畫
- 版本號必須根據語意化版本控制遞增:
  - **MAJOR**: 破壞性治理變更、移除/重新定義的原則
  - **MINOR**: 新原則、擴展的指南、新章節
  - **PATCH**: 釐清、措辭改進、錯字修正

**合規性驗證**:

- 所有拉取請求必須透過程式碼審查清單驗證憲法合規性
- 每季進行憲法稽核以確保持續遵守
- 違規必須在實作計畫的「複雜性追蹤」章節中記錄權衡理由
- 未經合理說明的違規會阻塞合併

**執行階段開發指南**:

- 使用 `.specify/templates/` 確保功能規劃與任務分解的一致性
- 遵循 `/speckit.plan` 工作流程進行功能實作規劃
- 在 plan-template.md 的「憲法檢查」階段參考本憲法

**版本**: 1.1.0 | **批准日期**: 2025-10-20 | **最後修訂**: 2025-10-20
